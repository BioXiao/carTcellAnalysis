---
title: "P89 RNA-seq CAR transcript analysis"
author: "James Eddy"
date: "March 30, 2016"
output: html_document
---

```{r global_opts, echo=FALSE}
knitr::opts_chunk$set(fig.width=8.5, fig.align='center',
                      echo=FALSE, warning=FALSE, message=FALSE)
# knitr::opts_knit$set(root.dir = "..")
```

```{r load_packages}
library(stringr)
library(dplyr)
library(ggplot2)
library(viridis)
library(rtracklayer)
library(ggthemes)
myCbPal <- colorblind_pal()(8)
myCbPal[c(1, 3, 6)] <- myCbPal[c(6, 1, 3)]
myCbPal[3] <- "#666666"
```

```{r load_data}
load("data/sample_metrics_data.RData")
load("data/sample_rapmap_data.RData")
load("data/sample_salmon_data.RData")

gff_file <- "~/Box Sync/data/projects/carTcellAnalysis/annotation/carPlus.gtf"
xcripts_gtf <- import.gff2(gff_file)
```

```{r prep_gtf_dat}
xcript_dat <- as.data.frame(xcripts_gtf)

car_dat <- as.data.frame(car_gtf) %>% 
    filter(seqnames == "CAR-1") %>% 
    mutate(segment = factor(transcript_id, levels = transcript_id))
```

```{r format_cov_dat}
# function to append CAR segment
get_segment <- Vectorize(function(pos) {
    xcript_dat %>% 
        filter(seqnames == "CAR-1",
               start < pos & end > pos) %>% 
        select(transcript_id) %>% 
        as.character()
})

lib_cov <- cov_dat %>% 
    filter(lib_id == cov_dat$lib_id[1]) %>% 
    mutate(segment = get_segment(pos)) %>% 
    select(pos, segment)

cov_dat <- cov_dat %>% 
    left_join(lib_cov, by = c("pos" = "pos"))
```


```{r data_clean_fxns}
# clean up duplicated headers
clean_dup_names <- function(df) {
    df_names <- names(df)
    is_dup_name <- duplicated(df_names)
    df_names[is_dup_name] <- str_c(df_names[is_dup_name], "2")
    names(df) <- df_names
    return(df)
}

# simplify library ID
simplify_lib_id <- function(df) {
    df_names <- names(df)
    is_lib_name <- str_detect(tolower(df_names), "lib.*id")
    df_names[is_lib_name] <- "lib_id"
    names(df) <- df_names
    
    df %>% 
        mutate(lib_id = str_extract(lib_id, "lib[0-9]+"))
}

# clean/relabel donor ID
clean_donor_ids <- function(df) {
    df %>% 
        mutate(donor_id = tolower(donor_id))
}

# relabel timepoints
relabel_timepoints <- function(df) {
    df %>% 
        mutate(timepoint = str_replace(timepoint, " ", ""),
               timepoint = str_replace(timepoint, "InfusionProduct", "IP"),
               timepoint = str_replace(timepoint, "Day0", "t0"),
               timepoint = str_replace(timepoint, "Day(7|8|9|12)", "t1"),
               timepoint = str_replace(timepoint, "Day(26|28|29|33)", "t2"))
}

relabel_transcripts <- function(df, xcript_dat) {
    df_names <- names(df)
    for (i in 1:length(df_names)) {
        if (df_names[i] %in% xcript_dat$seqnames) {
            xcript_row <- which(xcript_dat$seqnames %in% df_names[i])
            new_name <- xcript_dat$transcript_id[xcript_row]
            df_names[i] <- new_name
        }
    }
    names(df) <- df_names
    return(df)
}
```

```{r data_prep_fxn}
prep_cov_dat <- function(lib_dat, metric_dat) {
    lib_dat %>% 
    clean_dup_names() %>% 
    simplify_lib_id() %>%
    clean_donor_ids() %>% 
    select(lib_id, donor_id, timepoint) %>% 
    relabel_timepoints() %>% 
    left_join(cov_dat, by = c("lib_id" = "lib_id")) %>% 
    left_join(metric_dat %>% 
                  clean_dup_names() %>% 
                  simplify_lib_id() %>% 
                  select(lib_id, fastq_total_reads, 
                         median_cv_coverage, mapped_reads_w_dups),
              by = c("lib_id" = "lib_id")) %>% 
    left_join(map_rate_dat, by = c("lib_id" = "lib_id")) %>% 
    mutate(mapped_reads = fastq_total_reads * map_rate,
           norm_cov = cov / mapped_reads) %>% 
    left_join(salmon_quant_dat %>% 
                  # filter(Name == "CAR-1") %>% 
                  select(lib_id, Name, TPM) %>% 
                  spread(Name, TPM) %>% 
                  dplyr::rename(CAR = `CAR-1`) %>% 
                  relabel_transcripts(xcript_dat))
}
```


```{r prep_bulk_cov_dat}
bulk_cov_dat <- bulk_lib_dat %>% 
    prep_cov_dat(bulk_metric_dat) %>% 
    filter(donor_id %in% c("x145", "x194", "x228"))
```

```{r plot_fxn}
plot_coverage <- function(formatted_cov_dat, gtf_dat, split = TRUE, color_by = NULL) {
    height <- log10(max(formatted_cov_dat$cov, na.rm = TRUE) + 1)
    p_cov <- ggplot() +
        geom_rect(data = gtf_dat, 
                  aes(xmin = start, xmax = end, ymin = 0, ymax = height, 
                      fill = segment),
                  alpha = 0.5, colour = "gray") +
        geom_point(data = formatted_cov_dat, 
                   aes_string(x = "pos", y = "log10(cov + 1)", 
                       alpha = "log2(CAR + 1)", colour = color_by),
                   stroke = 0) +
        geom_smooth(data = formatted_cov_dat,
                    aes(x = pos, y = log10(cov + 1)),
                    se = FALSE, colour = myCbPal[2]) +
        scale_alpha_continuous(range = c(0.1, 0.8)) + 
        scale_fill_viridis(discrete = TRUE) +
        # scale_color_viridis(option = "inferno") +
        theme_gray()
    if (split) {
        p_cov <- p_cov +
            facet_grid(donor_id ~ timepoint)
    }
    return(p_cov)
}
```

```{r plot_bulk_cov, fig.height=6}
plot_coverage(bulk_cov_dat, car_dat)
```

```{r prep_p89_c1_cov_dat}
p89_c1_cov_dat <- sc_lib_dat %>% 
    prep_cov_dat(sc_metric_dat)
```

```{r plot_p89_c1_cov, fig.height=6}
plot_coverage(p89_c1_cov_dat, car_dat)
```

```{r prep_p85_c1_cov_dat}
p85_c1_cov_dat <- p85_lib_dat %>% 
    prep_cov_dat(p85_metric_dat)
```

```{r plot_p85_c1_cov, fig.height=4}
plot_coverage(p85_c1_cov_dat, car_dat)
```

```{r p89_cov_exploration, fig.height=6}
p89_c1_cov_dat %>% 
    plot_coverage(car_dat, color_by = "median_cv_coverage")
```

```{r boxplot}
p89_c1_cov_dat %>% 
    mutate(segment = factor(segment, 
                            levels = xcript_dat$transcript_id)) %>% 
    filter(!is.na(segment)) %>% 
    ggplot(aes(x = segment)) +
    geom_bar(aes(colour = donor_id), position = "dodge")
```

